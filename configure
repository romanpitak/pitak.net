#!/bin/bash

set -euo pipefail

rootDir="$(pwd)"

# ### Default values

production=false

# ### Adjust to previous user settings

# TODO include some file

# ### Functions
displayHelp() {
cat <<ASDF
    --production
    --development
ASDF
}

# ### Processing CLI parameters
while (( $# ))
do
    case "$1" in
        --development )
            production=false
            ;;
        --help )
            displayHelp
            exit
            ;;
        --production )
            production=true
            ;;
    esac
    shift
done


# output configuration
htmlDir='html'
cssDir="${htmlDir}"
jsDir="${htmlDir}"

# Nginx coinfiguration
serverName='localhost'
serverPort=8015

# sources configuration
srcDir='src'
coffeeDir="${srcDir}/coffee"
jadeDir="${srcDir}/jade"
rawDir="${srcDir}/raw"
sassDir="${srcDir}/sass"

# for the jade builder
pagesPath="${rootDir}/${jadeDir}/pages"
blogPath="${rootDir}/${jadeDir}/blog"
templatesPath="${rootDir}/${jadeDir}/templates"
htmlPath="${rootDir}/${htmlDir}"

# bin configuration
coffeeBin='./node_modules/.bin/coffee'
compassBin='compass'
npmBin='npm'
minifyBin='./node_modules/.bin/minify'

# mode configuration

if test true == "${production}"; then
    jadePretty='pretty: false'
    compassOutputStyle='output_style = :compressed'
    javascriptMinifier="${minifyBin} -js"
else
    jadePretty='pretty: true'
    compassOutputStyle='output_style = :nested'
    javascriptMinifier='cat'
fi

# do not edit notice
doNotEditNotice='DO NOT EDIT THIS FILE! Generated by ./configure'

echo "Writing ${jadeDir}/config.litcoffee"
cat > "${jadeDir}/config.litcoffee" <<SRC_JADE_CONFIG_LITCOFFEE

### ${doNotEditNotice}

    module.exports =
        blogPath: '${blogPath}'
        htmlPath: '${htmlPath}'
        pagesPath: '${pagesPath}'
        templatesPath: '${templatesPath}'
        ${jadePretty}

SRC_JADE_CONFIG_LITCOFFEE

echo "Writing .gitignore"
cat > .gitignore <<GITIGNORE

# ${doNotEditNotice}

/Makefile
/compass.rb
/package.json
/node_modules
.sass-cache
/${htmlDir}
/${jadeDir}/config.litcoffee
/nginx.conf
!.gitignore
GITIGNORE

echo "Writing package.json"
cat > package.json <<PACKAGE_JSON
{

    "_comment": "${doNotEditNotice}",

    "name": "pitak.net",
    "description": "Home page of Roman PitÃ¡k",
    "dependencies": {
        "jade": "^1.4.2",
        "coffee-script": "*",
        "marked": "*",
        "js-yaml": "^3.1.0",
        "lodash.assign": "^2.4.1",
        "mkdirp": "*",
        "minify": "*"
    },
    "private": true
}
PACKAGE_JSON

echo "Writing compass.rb"
cat > compass.rb <<COMPASS_RB

# ${doNotEditNotice}

project_type = :stand_alone
environment = :production
project_path = "${rootDir}"
css_dir = "${cssDir}"
sass_dir = "${sassDir}"

# images_dir
# generated_images_dir
# javascripts_dir

${compassOutputStyle}

sourcemap = false
disable_warnings = false

# These options are passed directly to the Sass compiler
#
# http://sass-lang.com/documentation/file.SASS_REFERENCE.html#options
#
# sass_options

line_comments = false

preferred_syntax = :sass

# fonts_dir

COMPASS_RB

echo "Writing nginx.conf"
cat > nginx.conf <<NGINX_CONF

# ${doNotEditNotice}

server {
    listen ${serverPort};

    root ${rootDir}/${htmlDir};
    index index.html;

    server_name ${serverName};

    error_page 404 /404/index.html;

    location / {
        try_files \$uri \$uri/ =404;
    }
}

NGINX_CONF

echo "Writing Makefile"
cat > Makefile <<MAKEFILE

# ${doNotEditNotice}

.PHONY: all css pages clean clean-html

all: clean-html ${htmlDir} css ${jsDir}/main.js pages

${htmlDir}: ${rawDir}
	mkdir --parents \$@
	cp --recursive $</* \$@

node_modules: package.json
	${npmBin} install

pages: node_modules
	${coffeeBin} ${jadeDir}/build.litcoffee

css: compass.rb
	${compassBin} compile --config $<

${jsDir}/main.js: node_modules ${coffeeDir}/*
	${coffeeBin} --no-header --print --compile ${coffeeDir} | \
	${javascriptMinifier} > \$@

clean: clean-html
	rm --recursive --force node_modules
	rm --recursive --force .sass-cache
	rm --recursive --force "${jadeDir}/config.litcoffee"
	rm --recursive --force compass.rb
	rm --force package.json
	rm --force Makefile
	@echo 'Makefile removed. Run ./configure to continue.'

clean-html:
	rm --recursive --force ${htmlDir}

MAKEFILE
