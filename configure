#!/bin/bash

set -euo pipefail

rootDir="$(pwd)"

# output configuration
htmlDir='html'
cssDir="${htmlDir}"
jsDir="${htmlDir}"

# sources configuration
srcDir='src'
coffeeDir="${srcDir}/coffee"
jadeDir="${srcDir}/jade"
rawDir="${srcDir}/raw"
sassDir="${srcDir}/sass"

# for the jade builder
pagesPath="${rootDir}/${jadeDir}/pages"
blogPath="${rootDir}/${jadeDir}/blog"
templatesPath="${rootDir}/${jadeDir}/templates"
htmlPath="${rootDir}/${htmlDir}"

# bin configuration
coffeeBin='coffee'
compassBin='compass'
npmBin='npm'
minifyBin='./node_modules/.bin/minify'

# do not edit notice
doNotEditNotice='DO NOT EDIT THIS FILE! Generated by ./configure'

echo "Writing ${jadeDir}/config.litcoffee"
cat > "${jadeDir}/config.litcoffee" <<SRC_JADE_CONFIG_LITCOFFEE

### ${doNotEditNotice}

    module.exports =
        blogPath: '${blogPath}'
        htmlPath: '${htmlPath}'
        pagesPath: '${pagesPath}'
        templatesPath: '${templatesPath}'
        pretty: false

SRC_JADE_CONFIG_LITCOFFEE

echo "Writing .gitignore"
cat > .gitignore <<GITIGNORE

# ${doNotEditNotice}

/Makefile
/compass.rb
/package.json
/node_modules
.sass-cache
/${htmlDir}
/${jadeDir}/config.litcoffee
!.gitignore
GITIGNORE

echo "Writing package.json"
cat > package.json <<PACKAGE_JSON
{

    "_comment": "${doNotEditNotice}",

    "name": "pitak.net",
    "description": "Home page of Roman PitÃ¡k",
    "dependencies": {
        "jade": "^1.4.2",
        "coffee-script": "*",
        "marked": "*",
        "js-yaml": "^3.1.0",
        "lodash.assign": "^2.4.1",
        "mkdirp": "*",
        "minify": "*"
    },
    "private": true
}
PACKAGE_JSON

echo "Writing compass.rb"
cat > compass.rb <<COMPASS_RB

# ${doNotEditNotice}

project_type = :stand_alone
environment = :production
project_path = "${rootDir}"
css_dir = "${cssDir}"
sass_dir = "${sassDir}"

# images_dir
# generated_images_dir
# javascripts_dir

# The output style for the compiled css
#
# - :nested
# - :expanded
# - :compact
# - :compressed
#
output_style = :compressed

sourcemap = false
disable_warnings = false

# These options are passed directly to the Sass compiler
#
# http://sass-lang.com/documentation/file.SASS_REFERENCE.html#options
#
# sass_options

line_comments = false

preferred_syntax = :sass

# fonts_dir

COMPASS_RB

echo "Writing Makefile"
cat > Makefile <<MAKEFILE

# ${doNotEditNotice}

.PHONY: all css pages clean clean-html

all: clean-html ${htmlDir} css ${jsDir}/main.js pages

${htmlDir}: ${rawDir}
	mkdir --parents \$@
	cp --recursive $</* \$@

node_modules: package.json
	${npmBin} install

pages: node_modules
	${coffeeBin} ${jadeDir}/build.litcoffee

css: compass.rb
	${compassBin} compile --config $<

${jsDir}/main.js: node_modules ${coffeeDir}/*
	${coffeeBin} --no-header --print --compile ${coffeeDir} | \
	${minifyBin} -js > \$@

clean: clean-html
	rm --recursive --force node_modules
	rm --recursive --force .sass-cache
	rm --recursive --force "${jadeDir}/config.litcoffee"
	rm --recursive --force compass.rb
	rm --force package.json
	rm --force Makefile

clean-html:
	rm --recursive --force ${htmlDir}

MAKEFILE
